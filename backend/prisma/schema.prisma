generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  user
  moderator
  admin
}

enum RequestStatus {
  pending
  accepted
  rejected
  completed
  cancelled
}

enum SkillProficiency {
  beginner
  intermediate
  expert
}

enum NotificationType {
  request_received
  request_accepted
  request_rejected
  login_alert
  post_liked
  post_commented
  message_received
  follow
}

enum ReportStatus {
  pending
  resolved
  dismissed
}

enum AuditAction {
  user_suspended
  user_unsuspended
  user_deleted
  user_role_changed
  post_deleted
  comment_deleted
  review_deleted
  report_created
  report_resolved
}

model User {
  id                      String             @id @default(auto()) @map("_id") @db.ObjectId
  name                    String
  email                   String             @unique
  password                String
  role                    Role               @default(user)
  isSuspended             Boolean            @default(false)
  suspensionEndsAt        DateTime?
  course                  String?
  year                    Int?
  bio                     String?
  profilePic              String?
  followersCount          Int                @default(0)
  followingCount          Int                @default(0)
  postsCount              Int                @default(0)
  resetToken              String?
  resetTokenExpiry        DateTime?
  emailVerified           Boolean            @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?
  twoFactorSecret         String?
  twoFactorEnabled        Boolean            @default(false)
  createdAt               DateTime           @default(now())
  // New fields
  linkedInUrl             String?
  linkedInVerified        Boolean            @default(false)
  githubUrl               String?
  githubVerified          Boolean            @default(false)
  portfolioUrl            String?
  portfolioVerified       Boolean            @default(false)
  profileViews            Int                @default(0)
  lastActiveAt            DateTime?
  skills                  Skill[]
  posts                   Post[]
  sentRequests            Request[]          @relation("RequestsSent")
  receivedRequests        Request[]          @relation("RequestsReceived")
  messages                Message[]          @relation("UserMessages")
  chatParticipants        ChatParticipant[]
  notifications           Notification[]
  settings                UserSettings?
  followers               Follow[]           @relation("Following")
  following               Follow[]           @relation("Followers")
  likes                   Like[]
  comments                Comment[]
  reviewsGiven            Review[]           @relation("ReviewsGiven")
  reviewsReceived         Review[]           @relation("ReviewsReceived")
  bookmarks               Bookmark[]
  favorites               Favorite[]         @relation("FavoritesGiven")
  favoriteOf              Favorite[]         @relation("FavoritesReceived")
  profileViewsHistory     ProfileView[]
  skillEndorsements       SkillEndorsement[]
  deviceSessions          DeviceSession[]
  photos                  UserPhoto[]
  achievements            Achievement[]
  activities              Activity[]
  skillRecommendations    SkillRecommendation[]
  modNotesCreated         ModNote[]

  reportsCreated  Report[]   @relation("ReportsCreated")
  reportsReceived Report[]   @relation("ReportsReceived")
  reportsResolved Report[]   @relation("ReportsResolved")
  auditLogs       AuditLog[] @relation("AuditLogsActor")
}

model Skill {
  id             String               @id @default(auto()) @map("_id") @db.ObjectId
  userId         String               @db.ObjectId
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  title          String
  description    String
  category       String
  subcategory    String?
  priceRange     String?
  proficiency    SkillProficiency     @default(beginner)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  requests       Request[]
  endorsements   SkillEndorsement[]
  certifications SkillCertification[]

  @@index([title])
  @@index([category])
  @@index([proficiency])
}

model Post {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String    @db.ObjectId
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  content     String
  image       String?
  isPinned    Boolean   @default(false)
  pinnedAt    DateTime?
  scheduledAt DateTime? // For scheduled posts
  isScheduled Boolean   @default(false)
  createdAt   DateTime  @default(now())
  comments    Comment[]
  activities  Activity[] @relation("PostActivity")

  @@index([userId])
  @@index([isPinned])
  @@index([scheduledAt])
  @@index([isScheduled])
}

model Like {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  postId    String   @db.ObjectId
  userId    String   @db.ObjectId
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Comment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  postId    String   @db.ObjectId
  userId    String   @db.ObjectId
  text      String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
}

model Request {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  fromUserId     String        @db.ObjectId
  toUserId       String        @db.ObjectId
  skillId        String        @db.ObjectId
  status         RequestStatus @default(pending)
  message        String?
  deadline       DateTime?
  isUrgent       Boolean       @default(false)
  counterOffer   String?
  counterPrice   String?
  completedAt    DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  fromUser       User          @relation("RequestsSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser         User          @relation("RequestsReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  skill          Skill         @relation(fields: [skillId], references: [id], onDelete: Cascade)
  reminderSentAt DateTime?

  @@index([toUserId, status])
  @@index([deadline])
  @@index([isUrgent])
}

model Chat {
  id           String            @id @default(auto()) @map("_id") @db.ObjectId
  name         String?
  isGroupChat  Boolean           @default(false)
  createdAt    DateTime          @default(now())
  messages     Message[]
  participants ChatParticipant[]
}

model ChatParticipant {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  chatId      String   @db.ObjectId
  userId      String   @db.ObjectId
  chat        Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt    DateTime @default(now())
  lastReadAt  DateTime @default(now())
  unreadCount Int      @default(0)

  @@unique([chatId, userId])
}

model Message {
  id            String            @id @default(auto()) @map("_id") @db.ObjectId
  chatId        String            @db.ObjectId
  senderId      String            @db.ObjectId
  text          String
  attachmentUrl String?
  isPinned      Boolean           @default(false)
  edited        Boolean           @default(false)
  timestamp     DateTime          @default(now())
  chat          Chat              @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender        User              @relation("UserMessages", fields: [senderId], references: [id], onDelete: Cascade)
  reactions     MessageReaction[]
  readReceipts  MessageRead[]

  @@index([chatId])
  @@index([senderId])
  @@index([isPinned])
}

model MessageReaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  messageId String   @db.ObjectId
  userId    String   @db.ObjectId
  emoji     String
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model MessageRead {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  messageId String   @db.ObjectId
  userId    String   @db.ObjectId
  readAt    DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model Notification {
  id        String           @id @default(auto()) @map("_id") @db.ObjectId
  userId    String           @db.ObjectId
  type      NotificationType
  title     String
  message   String
  relatedId String? // ID of related resource (request, user, etc)
  read      Boolean          @default(false)
  isPinned  Boolean          @default(false)
  archived  Boolean          @default(false)
  actionUrl String? // URL for quick action
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([type])
  @@index([isPinned])
  @@index([archived])
}

model UserSettings {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Privacy Settings
  isPrivateProfile     Boolean @default(false)
  allowMessages        String  @default("everyone") // everyone, followers, none
  allowRequestsFromAll Boolean @default(true)

  // Notification Settings
  emailNotifications    Boolean @default(true)
  pushNotifications     Boolean @default(true)
  requestNotifications  Boolean @default(true)
  messageNotifications  Boolean @default(true)
  activityNotifications Boolean @default(true)
  likeNotifications     Boolean @default(true)
  commentNotifications  Boolean @default(true)
  followNotifications   Boolean @default(true)
  quietHoursStart       String? // HH:mm format
  quietHoursEnd         String? // HH:mm format

  // Appearance Settings
  theme         String @default("dark") // Always dark mode
  colorPalette  String @default("champagne") // obsidian-blue, emerald, royal-purple, champagne, crimson, midnight-teal, graphite, pearl, carbon-blue, mocha, bronze, gold
  language      String @default("en")

  // Security Settings
  twoFactorEnabled Boolean   @default(false)
  lastLoginAt      DateTime?
  updatedAt        DateTime  @updatedAt
}

model Follow {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  followerId  String   @db.ObjectId
  followingId String   @db.ObjectId
  createdAt   DateTime @default(now())

  follower  User @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Review {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  authorId  String   @db.ObjectId
  userId    String   @db.ObjectId
  rating    Int // 1-5 stars
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author User @relation("ReviewsGiven", fields: [authorId], references: [id], onDelete: Cascade)
  user   User @relation("ReviewsReceived", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([authorId, userId])
  @@index([userId])
  @@index([authorId])
}

model Report {
  id                String       @id @default(auto()) @map("_id") @db.ObjectId
  reporterId        String       @db.ObjectId
  reason            String
  description       String
  reportedUserId    String?      @db.ObjectId
  reportedPostId    String?      @db.ObjectId
  reportedMessageId String?      @db.ObjectId
  status            ReportStatus @default(pending)
  resolvedBy        String?      @db.ObjectId
  resolutionNote    String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  reporter       User      @relation("ReportsCreated", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser   User?     @relation("ReportsReceived", fields: [reportedUserId], references: [id], onDelete: Cascade)
  resolvedByUser User?     @relation("ReportsResolved", fields: [resolvedBy], references: [id], onDelete: SetNull)
  modNotes       ModNote[]

  @@index([reporterId])
  @@index([reportedUserId])
  @@index([reportedPostId])
  @@index([reportedMessageId])
  @@index([status])
  @@index([createdAt])
}

model AuditLog {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  action     AuditAction
  actorId    String      @db.ObjectId
  targetId   String?     @db.ObjectId
  targetType String?
  details    String?
  createdAt  DateTime    @default(now())

  actor User @relation("AuditLogsActor", fields: [actorId], references: [id], onDelete: Cascade)

  @@index([actorId])
  @@index([action])
  @@index([createdAt])
}

model BlockedUser {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  blockerId String   @db.ObjectId
  blockedId String   @db.ObjectId
  createdAt DateTime @default(now())

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

model Bookmark {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  postId    String   @db.ObjectId
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

// New models for missing features

model Favorite {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String   @db.ObjectId
  favoriteUserId String   @db.ObjectId
  createdAt      DateTime @default(now())

  user         User @relation("FavoritesGiven", fields: [userId], references: [id], onDelete: Cascade)
  favoriteUser User @relation("FavoritesReceived", fields: [favoriteUserId], references: [id], onDelete: Cascade)

  @@unique([userId, favoriteUserId])
  @@index([userId])
  @@index([favoriteUserId])
}

model ProfileView {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  userId   String   @db.ObjectId
  viewerId String   @db.ObjectId
  viewedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([viewerId])
  @@index([viewedAt])
}

model SkillEndorsement {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  skillId    String   @db.ObjectId
  endorserId String   @db.ObjectId
  createdAt  DateTime @default(now())

  skill    Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)
  endorser User  @relation(fields: [endorserId], references: [id], onDelete: Cascade)

  @@unique([skillId, endorserId])
  @@index([skillId])
  @@index([endorserId])
}

model SkillCertification {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  skillId        String    @db.ObjectId
  name           String
  issuer         String
  issueDate      DateTime?
  expiryDate     DateTime?
  certificateUrl String?
  createdAt      DateTime  @default(now())

  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@index([skillId])
}

model RequestTemplate {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  title     String
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model ModNote {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  reportId    String   @db.ObjectId
  moderatorId String   @db.ObjectId
  note        String
  createdAt   DateTime @default(now())

  report    Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  moderator User   @relation(fields: [moderatorId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([moderatorId])
}

model DeviceSession {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  deviceId     String
  deviceName   String?
  ipAddress    String?
  userAgent    String?
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deviceId])
}

model UserPhoto {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  url       String
  caption   String?
  order     Int      @default(0)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([order])
}

model Achievement {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  type        String // "top_skill", "most_followers", etc
  title       String
  description String?
  icon        String?
  earnedAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
  @@index([type])
}
model Activity {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  type        String   // "login", "post_created", "follow", "skill_endorsed", etc
  description String?
  postId      String?  @db.ObjectId
  post        Post?    @relation("PostActivity", fields: [postId], references: [id], onDelete: SetNull)
  targetUserId String? @db.ObjectId
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model SkillRecommendation {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  skillName String
  reason    String   // "based_on_endorsements", "trending_in_course", etc
  score     Float    // Relevance score 0-1
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillName])
  @@index([userId])
  @@index([score])
}