# Email Service Implementation - Password Reset

## ✅ Completed

Email service for password reset has been fully integrated with Nodemailer. The system supports multiple email providers and includes a fallback console mode for development.

---

## Setup Instructions

### 1. **Gmail Configuration** (Recommended for Development)

1. Enable 2-Factor Authentication on your Google Account
2. Generate an [App Password](https://myaccount.google.com/apppasswords)
3. Update `.env`:
```env
EMAIL_PROVIDER=gmail
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-16-character-app-password
EMAIL_FROM=noreply@xavlink.com
FRONTEND_URL=http://localhost:5173
```

### 2. **SMTP Configuration** (SendGrid, Mailgun, etc.)

```env
EMAIL_PROVIDER=smtp
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=apikey
SMTP_PASSWORD=your-sendgrid-api-key
EMAIL_FROM=noreply@xavlink.com
FRONTEND_URL=http://localhost:5173
```

### 3. **Development Mode** (Console Logging)

If you don't configure EMAIL_PROVIDER, emails will log to console:
```env
# Leave EMAIL_PROVIDER commented out or empty
FRONTEND_URL=http://localhost:5173
```

---

## Features

### Password Reset Email
- Professional HTML template
- Reset link valid for 1 hour
- Secure token generation (32-byte random)
- Fallback to console logging if email fails
- Doesn't expose user existence (security best practice)

### Additional Email Templates Ready
- Welcome email on registration (not yet integrated)
- Notification emails (not yet integrated)
- Both functions exist in `emailService.js`

---

## How It Works

### 1. User Requests Password Reset
```
POST /api/auth/forgot-password
{ "email": "user@example.com" }
```

### 2. Backend Generates Token & Sends Email
- Token: 32-byte random hex string
- Expiry: 1 hour from generation
- Email: HTML template with reset link
- Response: Generic message (doesn't expose user existence)

### 3. User Clicks Reset Link
```
GET /reset-password?token=abc123...
```

### 4. User Submits New Password
```
POST /api/auth/reset-password
{ 
  "token": "abc123...",
  "newPassword": "newPassword123"
}
```

### 5. Backend Validates & Updates
- Validates token exists and isn't expired
- Hashes new password with bcrypt
- Clears reset token
- Returns JWT token for auto-login

---

## Environment Variables

```env
# Email Provider (gmail, smtp, or empty for console)
EMAIL_PROVIDER=gmail

# Gmail
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=app-specific-password

# SMTP Alternative
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=username
SMTP_PASSWORD=password

# Common
EMAIL_FROM=noreply@xavlink.com
FRONTEND_URL=http://localhost:5173
```

---

## Testing Email Service

### Via Console Mode (Development)
1. Leave `EMAIL_PROVIDER` empty in .env
2. Request password reset
3. Check backend console for logged reset link

### Via Gmail
1. Configure app-specific password in Google Account
2. Set `EMAIL_PROVIDER=gmail` in .env
3. Add credentials to .env
4. Request password reset
5. Check email inbox for reset link

### Verify Email Connection
The email service runs `transporter.verify()` on startup:
```
✅ Email service configured and ready
```

If you see warnings, check your credentials in .env.

---

## Code Structure

### Files Created/Modified

**New Files:**
- `backend/src/services/emailService.js` - Email service module
  - `sendPasswordResetEmail()` - Password reset emails
  - `sendWelcomeEmail()` - Welcome on registration (ready)
  - `sendNotificationEmail()` - Custom notifications (ready)
  - `verifyEmail()` - Test email connectivity

**Modified Files:**
- `backend/src/controllers/authController.js`
  - Updated `forgotPassword()` to send emails
  - Already integrated with password reset flow
  
- `backend/package.json`
  - Added `nodemailer` dependency

- `backend/.env`
  - Added email configuration variables

---

## Error Handling

### Email Fails
- Password reset token is still generated and stored
- Email failure doesn't block the reset process
- Console warning logged for debugging
- User can still reset via direct token (if needed)

### Token Expires
- Token valid for exactly 1 hour
- After expiry, token is invalid for reset
- User must request password reset again

### Invalid Email
- Returns generic message (doesn't expose user existence)
- No email sent if user not found
- Security best practice: prevents account enumeration

---

## Production Deployment

### Recommended: SendGrid
1. Create SendGrid account (free tier available)
2. Get API key from SendGrid dashboard
3. Configure SMTP variables in .env
4. Test email delivery

### Alternative: AWS SES, Mailgun, etc.
All support SMTP protocol - use SMTP configuration above.

### Don't Use Gmail
❌ Gmail app-specific passwords have rate limits
❌ Not recommended for production scale
✅ Use SendGrid, Mailgun, or AWS SES instead

---

## Testing Checklist

- [ ] Nodemailer installed (`npm install nodemailer`)
- [ ] Email service created (`src/services/emailService.js`)
- [ ] Auth controller updated to use email service
- [ ] .env file has email configuration
- [ ] Test password reset workflow end-to-end
- [ ] Verify email received or logged to console
- [ ] Test token expiry (wait 1+ hour)
- [ ] Test invalid token rejection

---

## Next Steps (Optional)

1. **Integrate Welcome Email** - Send on user registration
2. **Notification Emails** - Email notifications for follows, messages, etc.
3. **Email Templates** - Create more professional templates
4. **Rate Limiting** - Prevent email spam (email per IP/user)
5. **Webhook Handling** - Track bounce/complaint events from email provider
6. **Logging** - Log all email sends to database for audit trail

---

## Support

**Gmail Issue:** Use [App Passwords](https://myaccount.google.com/apppasswords), not your regular Gmail password

**SMTP Issue:** Test SMTP credentials with online tool like [SMTP Test](https://mxtoolbox.com/smtp)

**Email Not Received:** Check spam folder, verify sender domain reputation

---

## Email Verification

### Overview
- Adds `emailVerified` (Boolean), `verificationToken` (String), and `verificationTokenExpiry` (DateTime) to the User model.
- Registration sends a verification email with a 24-hour token.
- Login blocks unverified users and resends the verification email automatically.
- Endpoints provided to verify and to resend verification emails.

### Routes
- GET `/api/auth/verify-email?token=...` — Verifies email using token from the link.
- POST `/api/auth/resend-verification` — Resends verification email to a non-verified account.

### Flow
1. Register → backend generates token and emails verification link.
2. Click link → frontend hits `GET /api/auth/verify-email?token=...`.
3. Login → if not verified, backend resends link and blocks login.

### Environment
Ensure `FRONTEND_URL` is set (example: `http://localhost:5173`) so links point to your app.

### Try It (dev)
- Register a new user.
- Observe terminal (console mode) or inbox (gmail/smtp) for verification email.
- Hit the verify endpoint (link in email).
- Login now succeeds once verified.
