import React, { useEffect, useState } from "react";
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  FlatList,
  TextInput,
  ScrollView,
  Dimensions,
} from "react-native";
import { Picker } from "@react-native-picker/picker";
import { useAuth } from "../context/AuthContext";
import { adminService } from "../services/api";

const SECTIONS = [
  { key: "users", label: "Users" },
  { key: "posts", label: "Posts" },
  { key: "comments", label: "Comments" },
  { key: "reviews", label: "Reviews" },
  { key: "reports", label: "Reports" },
  { key: "logs", label: "Logs" },
];

const AdminDashboardScreen = () => {
  const { user } = useAuth();

  const [activeSection, setActiveSection] = useState("users");
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  const [search, setSearch] = useState("");
  const [roleFilter, setRoleFilter] = useState("");
  const [suspendedFilter, setSuspendedFilter] = useState("");
  const [verifiedFilter, setVerifiedFilter] = useState("");

  // Posts section state
  const [posts, setPosts] = useState([]);
  const [postsLoading, setPostsLoading] = useState(false);

  // Comments section state
  const [comments, setComments] = useState([]);
  const [commentsLoading, setCommentsLoading] = useState(false);

  // Reviews section state
  const [reviews, setReviews] = useState([]);
  const [reviewsLoading, setReviewsLoading] = useState(false);

  // Reports section state
  const [reports, setReports] = useState([]);
  const [reportsLoading, setReportsLoading] = useState(false);
  const [reportStatusFilter, setReportStatusFilter] = useState("");

  // Logs section state
  const [logs, setLogs] = useState([]);
  const [logsLoading, setLogsLoading] = useState(false);

  const [selectedIds, setSelectedIds] = useState([]);
  const [refreshing, setRefreshing] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [editForm, setEditForm] = useState({
    name: "",
    email: "",
    role: "user",
  });
  const [verifyingId, setVerifyingId] = useState(null);

  const [stats, setStats] = useState(null);
  const [statsLoading, setStatsLoading] = useState(false);

  // Dashboard stats
  const fetchStats = async () => {
    setStatsLoading(true);
    try {
      const data = await adminService.getStats();
      setStats(data);
    } catch (e) {
      // Optionally handle error
    } finally {
      setStatsLoading(false);
    }
  };

  const fetchUsers = async () => {
    setLoading(true);
    setError("");
    try {
      const data = await adminService.listUsers({
        search,
        role: roleFilter,
        suspended: suspendedFilter,
        verified: verifiedFilter,
      });
      console.log("API Response:", data);
      // Handle different response formats
      if (Array.isArray(data)) {
        setUsers(data);
      } else if (data?.users && Array.isArray(data.users)) {
        setUsers(data.users);
      } else {
        setUsers([]);
        setError("Unexpected response format from server");
      }
    } catch (e) {
      console.error("Error fetching users:", e);
      setError(
        e?.response?.data?.message || e?.message || "Failed to load users"
      );
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  const fetchPosts = async () => {
    setPostsLoading(true);
    try {
      const data = await adminService.listPosts({ search });
      setPosts(Array.isArray(data) ? data : data?.posts || []);
    } catch (e) {
      console.error("Error fetching posts:", e);
      setError(e?.response?.data?.message || "Failed to load posts");
    } finally {
      setPostsLoading(false);
    }
  };

  const fetchComments = async () => {
    setCommentsLoading(true);
    try {
      const data = await adminService.listComments({ search });
      setComments(Array.isArray(data) ? data : data?.comments || []);
    } catch (e) {
      console.error("Error fetching comments:", e);
      setError(e?.response?.data?.message || "Failed to load comments");
    } finally {
      setCommentsLoading(false);
    }
  };

  const fetchReviews = async () => {
    setReviewsLoading(true);
    try {
      const data = await adminService.listReviews({ search });
      setReviews(Array.isArray(data) ? data : data?.reviews || []);
    } catch (e) {
      console.error("Error fetching reviews:", e);
      setError(e?.response?.data?.message || "Failed to load reviews");
    } finally {
      setReviewsLoading(false);
    }
  };

  const fetchReports = async () => {
    setReportsLoading(true);
    try {
      const data = await adminService.listReports({ 
        search, 
        status: reportStatusFilter 
      });
      setReports(Array.isArray(data) ? data : data?.reports || []);
    } catch (e) {
      console.error("Error fetching reports:", e);
      setError(e?.response?.data?.message || "Failed to load reports");
    } finally {
      setReportsLoading(false);
    }
  };

  const fetchLogs = async () => {
    setLogsLoading(true);
    try {
      const data = await adminService.listLogs({ search });
      setLogs(Array.isArray(data) ? data : data?.logs || []);
    } catch (e) {
      console.error("Error fetching logs:", e);
      setError(e?.response?.data?.message || "Failed to load logs");
    } finally {
      setLogsLoading(false);
    }
  };

  useEffect(() => {
    fetchStats();
    if (activeSection === "users") fetchUsers();
    if (activeSection === "posts") fetchPosts();
    if (activeSection === "comments") fetchComments();
    if (activeSection === "reviews") fetchReviews();
    if (activeSection === "reports") fetchReports();
    if (activeSection === "logs") fetchLogs();
  }, [activeSection]);

  const handleEditStart = (item) => {
    setEditingId(item.id);
    setEditForm({
      name: item.name || "",
      email: item.email || "",
      role: item.role || "user",
    });
  };

  const handleEditCancel = () => {
    setEditingId(null);
    setEditForm({ name: "", email: "", role: "user" });
  };

  const handleEditSave = async (id) => {
    try {
      await adminService.updateUser(id, editForm);
      setEditingId(null);
      fetchUsers();
    } catch (e) {
      setError(e?.response?.data?.message || "Failed to update user");
    }
  };

  const handleSetRole = async (id, role) => {
    try {
      await adminService.setRole(id, role);
      fetchUsers();
    } catch (e) {
      setError(e?.response?.data?.message || "Failed to update role");
    }
  };

  const handleSetVerified = async (id, verified) => {
    setVerifyingId(id);
    try {
      await adminService.setVerified(id, verified);
      fetchUsers();
    } catch (e) {
      setError(e?.response?.data?.message || "Failed to update verification");
    } finally {
      setVerifyingId(null);
    }
  };

  const handleResendVerification = async (email) => {
    setVerifyingId(email);
    try {
      await adminService.resendVerification(email);
    } catch (e) {
      setError(e?.response?.data?.message || "Failed to resend verification");
    } finally {
      setVerifyingId(null);
    }
  };
  const toggleSelect = (id) => {
    setSelectedIds((prev) =>
      prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id]
    );
  };

  /* =========================
     BULK ACTIONS
  ========================== */
  const handleBulkSuspend = async () => {
    if (selectedIds.length === 0) return;
    try {
      // Only suspend users who are not already suspended
      const toSuspend = users
        .filter((u) => selectedIds.includes(u.id) && !u.isSuspended)
        .map((u) => u.id);
      if (toSuspend.length === 0) return;
      await adminService.bulkSuspend(toSuspend, true);
      setSelectedIds([]);
      fetchUsers();
    } catch (e) {
      setError(e?.response?.data?.message || "Bulk suspend failed");
    }
  };

  const handleBulkUnsuspend = async () => {
    if (selectedIds.length === 0) return;
    try {
      // Only unsuspend users who are currently suspended
      const toUnsuspend = users
        .filter((u) => selectedIds.includes(u.id) && u.isSuspended)
        .map((u) => u.id);
      if (toUnsuspend.length === 0) return;
      await adminService.bulkSuspend(toUnsuspend, false);
      setSelectedIds([]);
      fetchUsers();
    } catch (e) {
      setError(e?.response?.data?.message || "Bulk unsuspend failed");
    }
  };

  const handleBulkDelete = async () => {
    if (selectedIds.length === 0) return;
    try {
      await adminService.bulkDelete(selectedIds);
      setSelectedIds([]);
      fetchUsers();
    } catch (e) {
      setError(e?.response?.data?.message || "Bulk delete failed");
    }
  };

  /* =========================
     RENDER
  ========================== */
  return (
    <View style={styles.container}>
      {activeSection === "users" ? (
        <FlatList
          ListHeaderComponent={
            <>
              <Text style={styles.header}>Admin / Moderator Dashboard</Text>
              <View style={styles.statsRow}>
                {statsLoading || !stats ? (
                  <Text>Loading stats...</Text>
                ) : (
                  <>
                    <View style={[styles.statCard, { backgroundColor: "#e0e7ff" }]}>
                      <Text style={styles.statValue}>{stats.totalUsers}</Text>
                      <Text style={styles.statLabel}>Total Users</Text>
                    </View>
                    <View style={[styles.statCard, { backgroundColor: "#bbf7d0" }]}>
                      <Text style={styles.statValue}>{stats.verifiedUsers}</Text>
                      <Text style={styles.statLabel}>Verified</Text>
                    </View>
                    <View style={[styles.statCard, { backgroundColor: "#fee2e2" }]}>
                      <Text style={styles.statValue}>{stats.suspendedUsers}</Text>
                      <Text style={styles.statLabel}>Suspended</Text>
                    </View>
                    <View style={[styles.statCard, { backgroundColor: "#fef9c3" }]}>
                      <Text style={styles.statValue}>{stats.totalPosts}</Text>
                      <Text style={styles.statLabel}>Total Posts</Text>
                    </View>
                    <View style={[styles.statCard, { backgroundColor: "#f3e8ff" }]}>
                      <Text style={styles.statValue}>{stats.postsThisWeek}</Text>
                      <Text style={styles.statLabel}>Posts This Week</Text>
                    </View>
                  </>
                )}
              </View>
              <View style={styles.tabRow}>
                {SECTIONS.map((section) => (
                  <TouchableOpacity
                    key={section.key}
                    style={[styles.tabButton, activeSection === section.key && styles.activeTab]}
                    onPress={() => setActiveSection(section.key)}
                  >
                    <Text style={[styles.tabText, activeSection === section.key && styles.activeTabText]}>
                      {section.label}
                    </Text>
                  </TouchableOpacity>
                ))}
              </View>
              <Text style={styles.sectionTitle}>Users</Text>
              <View style={{ marginBottom: 8, backgroundColor: "#f8fafc", padding: 8, borderRadius: 8 }}>
                <View style={{ marginBottom: 8 }}>
                  <Text style={styles.filterLabel}>Search</Text>
                  <View style={styles.inputBox}>
                    <TextInput
                      placeholder="Name or email"
                      value={search}
                      onChangeText={setSearch}
                      onSubmitEditing={fetchUsers}
                      returnKeyType="search"
                    />
                  </View>
                </View>
                <View style={{ flexDirection: "row", gap: 8, marginBottom: 8 }}>
                  <View style={{ flex: 1 }}>
                    <Text style={styles.filterLabel}>Role</Text>
                    <Picker selectedValue={roleFilter} onValueChange={setRoleFilter}>
                      <Picker.Item label="All" value="" />
                      <Picker.Item label="User" value="user" />
                      <Picker.Item label="Moderator" value="moderator" />
                      <Picker.Item label="Admin" value="admin" />
                    </Picker>
                  </View>
                  <View style={{ flex: 1 }}>
                    <Text style={styles.filterLabel}>Status</Text>
                    <Picker selectedValue={suspendedFilter} onValueChange={setSuspendedFilter}>
                      <Picker.Item label="All" value="" />
                      <Picker.Item label="Active" value="false" />
                      <Picker.Item label="Suspended" value="true" />
                    </Picker>
                  </View>
                  <View style={{ flex: 1 }}>
                    <Text style={styles.filterLabel}>Verified</Text>
                    <Picker selectedValue={verifiedFilter} onValueChange={setVerifiedFilter}>
                      <Picker.Item label="All" value="" />
                      <Picker.Item label="Verified" value="true" />
                      <Picker.Item label="Unverified" value="false" />
                    </Picker>
                  </View>
                </View>
                <TouchableOpacity style={styles.filterBtn} onPress={fetchUsers} disabled={loading}>
                  <Text style={{ color: "#fff" }}>Apply</Text>
                </TouchableOpacity>
              </View>
              {error && (
                <View style={{ padding: 12, backgroundColor: "#fee2e2", borderRadius: 8, marginBottom: 8 }}>
                  <Text style={styles.error}>{error}</Text>
                </View>
              )}
              {loading && <Text style={{ marginBottom: 8 }}>Loading users...</Text>}
            </>
          }
          data={users}
          keyExtractor={(item) => item.id}
          refreshing={refreshing}
          onRefresh={() => { setRefreshing(true); fetchUsers(); }}
          renderItem={({ item }) => {
            const isEditing = editingId === item.id;
            return (
              <View style={[styles.userRow, selectedIds.includes(item.id) && styles.userRowSelected]}>
                <TouchableOpacity style={styles.checkbox} onPress={() => toggleSelect(item.id)}>
                  {selectedIds.includes(item.id) && <Text>✓</Text>}
                </TouchableOpacity>
                <View style={{ flex: 1 }}>
                  {isEditing ? (
                    <>
                      <TextInput style={{ fontWeight: "bold", marginBottom: 2 }} value={editForm.name} onChangeText={(v) => setEditForm((f) => ({ ...f, name: v }))} placeholder="Name" />
                      <TextInput style={{ marginBottom: 2 }} value={editForm.email} onChangeText={(v) => setEditForm((f) => ({ ...f, email: v }))} placeholder="Email" />
                      <Picker selectedValue={editForm.role} onValueChange={(v) => setEditForm((f) => ({ ...f, role: v }))}>
                        <Picker.Item label="User" value="user" />
                        <Picker.Item label="Moderator" value="moderator" />
                        <Picker.Item label="Admin" value="admin" />
                      </Picker>
                      <View style={{ flexDirection: "row", marginTop: 4 }}>
                        <TouchableOpacity style={[styles.actionBtn, { backgroundColor: "#3b82f6", marginRight: 4 }]} onPress={() => handleEditSave(item.id)}>
                          <Text style={styles.actionText}>Save</Text>
                        </TouchableOpacity>
                        <TouchableOpacity style={[styles.actionBtn, { backgroundColor: "#64748b" }]} onPress={handleEditCancel}>
                          <Text style={styles.actionText}>Cancel</Text>
                        </TouchableOpacity>
                      </View>
                    </>
                  ) : (
                    <>
                      <Text style={{ fontWeight: "bold" }}>{item.name}</Text>
                      <Text>{item.email}</Text>
                      <Text>Role: {item.role}</Text>
                      <Text style={{ color: item.isSuspended ? "#dc2626" : "#16a34a" }}>
                        {item.isSuspended ? "Suspended" : "Active"}
                      </Text>
                      <View style={{ flexDirection: "row", marginTop: 4, flexWrap: "wrap" }}>
                        <TouchableOpacity style={[styles.actionBtn, { backgroundColor: "#3b82f6", marginRight: 4 }]} onPress={() => handleEditStart(item)}>
                          <Text style={styles.actionText}>Edit</Text>
                        </TouchableOpacity>
                        <TouchableOpacity style={[styles.actionBtn, { backgroundColor: item.emailVerified ? "#64748b" : "#22c55e" }]} onPress={() => handleSetVerified(item.id, !item.emailVerified)} disabled={verifyingId === item.id}>
                          <Text style={styles.actionText}>{item.emailVerified ? "Mark Unverified" : "Mark Verified"}</Text>
                        </TouchableOpacity>
                        {!item.emailVerified && (
                          <TouchableOpacity style={[styles.actionBtn, { backgroundColor: "#fbbf24" }]} onPress={() => handleResendVerification(item.email)} disabled={verifyingId === item.email}>
                            <Text style={styles.actionText}>Resend Verification</Text>
                          </TouchableOpacity>
                        )}
                      </View>
                    </>
                  )}
                </View>
              </View>
            );
          }}
          ListEmptyComponent={loading ? <Text style={{ padding: 20, textAlign: "center" }}>Loading...</Text> : <Text style={{ padding: 20, textAlign: "center" }}>No users found</Text>}
          ListFooterComponent={selectedIds.length > 0 ? (
            <View style={styles.bulkRow}>
              {users.some((u) => selectedIds.includes(u.id) && !u.isSuspended) && (
                <TouchableOpacity style={[styles.actionBtn, { backgroundColor: "#fbbf24" }]} onPress={handleBulkSuspend}>
                  <Text style={styles.actionText}>Suspend</Text>
                </TouchableOpacity>
              )}
              {users.some((u) => selectedIds.includes(u.id) && u.isSuspended) && (
                <TouchableOpacity style={[styles.actionBtn, { backgroundColor: "#22c55e" }]} onPress={handleBulkUnsuspend}>
                  <Text style={styles.actionText}>Unsuspend</Text>
                </TouchableOpacity>
              )}
              <TouchableOpacity style={[styles.actionBtn, { backgroundColor: "#dc2626" }]} onPress={handleBulkDelete}>
                <Text style={styles.actionText}>Delete</Text>
              </TouchableOpacity>
            </View>
          ) : null}
        />
      ) : (
        <View style={styles.centered}>
          <Text style={styles.sectionTitle}>{SECTIONS.find((s) => s.key === activeSection)?.label}</Text>
          <Text>Section coming soon...</Text>
        </View>
      )}
    </View>
  );
};

const { width } = Dimensions.get("window");
const styles = StyleSheet.create({
                    <View
                      style={[styles.statCard, { backgroundColor: "#e0e7ff" }]}
                    >
                      <Text style={styles.statValue}>{stats.totalUsers}</Text>
                      <Text style={styles.statLabel}>Total Users</Text>
                    </View>
                    <View
                      style={[styles.statCard, { backgroundColor: "#bbf7d0" }]}
                    >
                      <Text style={styles.statValue}>
                        {stats.verifiedUsers}
                      </Text>
                      <Text style={styles.statLabel}>Verified</Text>
                    </View>
                    <View
                      style={[styles.statCard, { backgroundColor: "#fee2e2" }]}
                    >
                      <Text style={styles.statValue}>
                        {stats.suspendedUsers}
                      </Text>
                      <Text style={styles.statLabel}>Suspended</Text>
                    </View>
                    <View
                      style={[styles.statCard, { backgroundColor: "#fef9c3" }]}
                    >
                      <Text style={styles.statValue}>{stats.totalPosts}</Text>
                      <Text style={styles.statLabel}>Total Posts</Text>
                    </View>
                    <View
                      style={[styles.statCard, { backgroundColor: "#f3e8ff" }]}
                    >
                      <Text style={styles.statValue}>
                        {stats.postsThisWeek}
                      </Text>
                      <Text style={styles.statLabel}>Posts This Week</Text>
                    </View>
                  </>
                )}
              </View>

              {/* Tabs */}
              <View style={styles.tabRow}>
                {SECTIONS.map((section) => (
                  <TouchableOpacity
                    key={section.key}
                    style={[
                      styles.tabButton,
                      activeSection === section.key && styles.activeTab,
                    ]}
                    onPress={() => setActiveSection(section.key)}
                  >
                    <Text
                      style={[
                        styles.tabText,
                        activeSection === section.key && styles.activeTabText,
                      ]}
                    >
                      {section.label}
                    </Text>
                  </TouchableOpacity>
                ))}
              </View>

              <Text style={styles.sectionTitle}>Users</Text>

              {/* Filters */}
              <View
                style={{
                  marginBottom: 8,
                  backgroundColor: "#f8fafc",
                  padding: 8,
                  borderRadius: 8,
                }}
              >
                <View style={{ marginBottom: 8 }}>
                  <Text style={styles.filterLabel}>Search</Text>
                  <View style={styles.inputBox}>
                    <TextInput
                      placeholder="Name or email"
                      value={search}
                      onChangeText={setSearch}
                      onSubmitEditing={fetchUsers}
                      returnKeyType="search"
                    />
                  </View>
                </View>
                <View style={{ flexDirection: "row", gap: 8, marginBottom: 8 }}>
                  <View style={{ flex: 1 }}>
                    <Text style={styles.filterLabel}>Role</Text>
                    <Picker
                      selectedValue={roleFilter}
                      onValueChange={setRoleFilter}
                    >
                      <Picker.Item label="All" value="" />
                      <Picker.Item label="User" value="user" />
                      <Picker.Item label="Moderator" value="moderator" />
                      <Picker.Item label="Admin" value="admin" />
                    </Picker>
                  </View>
                  <View style={{ flex: 1 }}>
                    <Text style={styles.filterLabel}>Status</Text>
                    <Picker
                      selectedValue={suspendedFilter}
                      onValueChange={setSuspendedFilter}
                    >
                      <Picker.Item label="All" value="" />
                      <Picker.Item label="Active" value="false" />
                      <Picker.Item label="Suspended" value="true" />
                    </Picker>
                  </View>
                  <View style={{ flex: 1 }}>
                    <Text style={styles.filterLabel}>Verified</Text>
                    <Picker
                      selectedValue={verifiedFilter}
                      onValueChange={setVerifiedFilter}
                    >
                      <Picker.Item label="All" value="" />
                      <Picker.Item label="Verified" value="true" />
                      <Picker.Item label="Unverified" value="false" />
                    </Picker>
                  </View>
                </View>
                <TouchableOpacity
                  style={styles.filterBtn}
                  onPress={fetchUsers}
                  disabled={loading}
                >
                  <Text style={{ color: "#fff" }}>Apply</Text>
                </TouchableOpacity>
              </View>

              {error ? (
                <View
                  style={{
                    padding: 12,
                    backgroundColor: "#fee2e2",
                    borderRadius: 8,
                    marginBottom: 8,
                  }}
                >
                  <Text style={styles.error}>{error}</Text>
                </View>
              ) : null}
              {loading && (
                <Text style={{ marginBottom: 8 }}>Loading users...</Text>
              )}
            </>
          }
          data={users}
          keyExtractor={(item) => item.id}
          refreshing={refreshing}
          onRefresh={() => {
            setRefreshing(true);
            fetchUsers();
          }}
          renderItem={({ item }) => {
            const isEditing = editingId === item.id;
            return (
              <View
                style={[
                  styles.userRow,
                  selectedIds.includes(item.id) && styles.userRowSelected,
                ]}
              >
                <TouchableOpacity
                  style={styles.checkbox}
                  onPress={() => toggleSelect(item.id)}
                >
                  {selectedIds.includes(item.id) && <Text>✓</Text>}
                </TouchableOpacity>
                <View style={{ flex: 1 }}>
                  {isEditing ? (
                    <>
                      <TextInput
                        style={{ fontWeight: "bold", marginBottom: 2 }}
                        value={editForm.name}
                        onChangeText={(v) =>
                          setEditForm((f) => ({ ...f, name: v }))
                        }
                        placeholder="Name"
                      />
                      <TextInput
                        style={{ marginBottom: 2 }}
                        value={editForm.email}
                        onChangeText={(v) =>
                          setEditForm((f) => ({ ...f, email: v }))
                        }
                        placeholder="Email"
                      />
                      <Picker
                        selectedValue={editForm.role}
                        onValueChange={(v) =>
                          setEditForm((f) => ({ ...f, role: v }))
                        }
                      >
                        <Picker.Item label="User" value="user" />
                        <Picker.Item label="Moderator" value="moderator" />
                        <Picker.Item label="Admin" value="admin" />
                      </Picker>
                      <View style={{ flexDirection: "row", marginTop: 4 }}>
                        <TouchableOpacity
                          style={[
                            styles.actionBtn,
                            {
                              backgroundColor: "#3b82f6",
                              marginRight: 4,
                            },
                          ]}
                          onPress={() => handleEditSave(item.id)}
                        >
                          <Text style={styles.actionText}>Save</Text>
                        </TouchableOpacity>
                        <TouchableOpacity
                          style={[
                            styles.actionBtn,
                            { backgroundColor: "#64748b" },
                          ]}
                          onPress={handleEditCancel}
                        >
                          <Text style={styles.actionText}>Cancel</Text>
                        </TouchableOpacity>
                      </View>
                    </>
                  ) : (
                    <>
                      <Text style={{ fontWeight: "bold" }}>{item.name}</Text>
                      <Text>{item.email}</Text>
                      <Text>Role: {item.role}</Text>
                      <Text
                        style={{
                          color: item.isSuspended ? "#dc2626" : "#16a34a",
                        }}
                      >
                        {item.isSuspended ? "Suspended" : "Active"}
                      </Text>
                      <View
                        style={{
                          flexDirection: "row",
                          marginTop: 4,
                          flexWrap: "wrap",
                        }}
                      >
                        <TouchableOpacity
                          style={[
                            styles.actionBtn,
                            {
                              backgroundColor: "#3b82f6",
                              marginRight: 4,
                            },
                          ]}
                          onPress={() => handleEditStart(item)}
                        >
                          <Text style={styles.actionText}>Edit</Text>
                        </TouchableOpacity>
                        <TouchableOpacity
                          style={[
                            styles.actionBtn,
                            {
                              backgroundColor: item.emailVerified
                                ? "#64748b"
                                : "#22c55e",
                            },
                          ]}
                          onPress={() =>
                            handleSetVerified(item.id, !item.emailVerified)
                          }
                          disabled={verifyingId === item.id}
                        >
                          <Text style={styles.actionText}>
                            {item.emailVerified
                              ? "Mark Unverified"
                              : "Mark Verified"}
                          </Text>
                        </TouchableOpacity>
                        {!item.emailVerified && (
                          <TouchableOpacity
                            style={[
                              styles.actionBtn,
                              { backgroundColor: "#fbbf24" },
                            ]}
                            onPress={() => handleResendVerification(item.email)}
                            disabled={verifyingId === item.email}
                          >
                            <Text style={styles.actionText}>
                              Resend Verification
                            </Text>
                          </TouchableOpacity>
                        )}
                      </View>
                    </>
                  )}
                </View>
              </View>
            );
          }}
          ListEmptyComponent={
            loading ? (
              <Text style={{ padding: 20, textAlign: "center" }}>
                Loading...
              </Text>
            ) : (
              <View style={{ padding: 20, alignItems: "center" }}>
                <Text style={{ marginBottom: 8 }}>No users found</Text>
                {error && (
                  <Text style={{ fontSize: 12, color: "#64748b" }}>
                    Check error message above
                  </Text>
                )}
                {!error && (
                  <Text style={{ fontSize: 12, color: "#64748b" }}>
                    Try adjusting filters or pull to refresh
                  </Text>
                )}
              </View>
            )
          }
          ListFooterComponent={
            selectedIds.length > 0 ? (
              <View style={styles.bulkRow}>
                {/* Suspend button for users not already suspended */}
                {users.some(
                  (u) => selectedIds.includes(u.id) && !u.isSuspended
                ) && (
                  <TouchableOpacity
                    style={[styles.actionBtn, { backgroundColor: "#fbbf24" }]}
                    onPress={handleBulkSuspend}
                  >
                    <Text style={styles.actionText}>Suspend</Text>
                  </TouchableOpacity>
                )}
                {/* Unsuspend button for users already suspended */}
                {users.some(
                  (u) => selectedIds.includes(u.id) && u.isSuspended
                ) && (
                  <TouchableOpacity
                    style={[styles.actionBtn, { backgroundColor: "#22c55e" }]}
                    onPress={handleBulkUnsuspend}
                  >
                    <Text style={styles.actionText}>Unsuspend</Text>
                  </TouchableOpacity>
                )}
                </TouchableOpacity>
              </View>
            ) : null
          }
        />
      ) :       <TouchableOpacity
                  style={[styles.actionBtn, { backgroundColor: "#dc2626" }]}
                  onPress={handleBulkDelete}
                >
                  <Text style={styles.actionText}>Delete</Text>
          activeSection === "posts" ? (
        <FlatList
          ListHeaderComponent={
            <>
              <Text style={styles.sectionTitle}>Posts</Text>
              <View style={{ marginBottom: 8 }}>
                <Text style={styles.filterLabel}>Search</Text>
                <View style={styles.inputBox}>
                  <TextInput
                    placeholder="Search posts..."
                    onChangeText={setSearch}
                    onSubmitEditing={fetchPosts}
                  />
                </View>
              </View>
              <TouchableOpacity
                style={styles.filterBtn}
                onPress={fetchPosts}
                disabled={postsLoading}
              >
                <Text style={{ color: "#fff" }}>Search</Text>
              </TouchableOpacity>
            </>
          }
          data={posts}
          keyExtractor={(item) => item.id}
          renderItem={({ item }) => (
            <View style={styles.userRow}>
              <View style={{ flex: 1 }}>
                <Text style={{ fontWeight: "bold" }}>{item.title || item.content?.substring(0, 50)}</Text>
                <Text>{item.author?.name || "Unknown"}</Text>
                <Text style={{ fontSize: 12, color: "#64748b" }}>
                  {new Date(item.createdAt).toLocaleDateString()}
                </Text>
              </View>
            </View>
          )}
          ListEmptyComponent={
            postsLoading ? (
              <Text style={{ padding: 20, textAlign: "center" }}>Loading...</Text>
            ) : (
              <Text style={{ padding: 20, textAlign: "center" }}>No posts found</Text>
            )
          }
        />
      ) : activeSection === "comments" ? (
        <FlatList
          ListHeaderComponent={
            <>
              <Text style={styles.sectionTitle}>Comments</Text>
              <View style={{ marginBottom: 8 }}>
                <Text style={styles.filterLabel}>Search</Text>
                <View style={styles.inputBox}>
                  <TextInput
                    placeholder="Search comments..."
                    onChangeText={setSearch}
                    onSubmitEditing={fetchComments}
                  />
                </View>
              </View>
              <TouchableOpacity
                style={styles.filterBtn}
                onPress={fetchComments}
                disabled={commentsLoading}
              >
                <Text style={{ color: "#fff" }}>Search</Text>
              </TouchableOpacity>
            </>
          }
          data={comments}
          keyExtractor={(item) => item.id}
          renderItem={({ item }) => (
            <View style={styles.userRow}>
              <View style={{ flex: 1 }}>
                <Text style={{ fontWeight: "bold" }}>{item.author?.name || "Unknown"}</Text>
                <Text>{item.content?.substring(0, 60)}...</Text>
                <Text style={{ fontSize: 12, color: "#64748b" }}>
                  Post: {item.post?.title || "Unknown"}
                </Text>
              </View>
            </View>
          )}
          ListEmptyComponent={
            commentsLoading ? (
              <Text style={{ padding: 20, textAlign: "center" }}>Loading...</Text>
            ) : (
              <Text style={{ padding: 20, textAlign: "center" }}>No comments found</Text>
            )
          }
        />
      ) : activeSection === "reviews" ? (
        <FlatList
          ListHeaderComponent={
            <>
              <Text style={styles.sectionTitle}>Reviews</Text>
              <View style={{ marginBottom: 8 }}>
                <Text style={styles.filterLabel}>Search</Text>
                <View style={styles.inputBox}>
                  <TextInput
                    placeholder="Search reviews..."
                    onChangeText={setSearch}
                    onSubmitEditing={fetchReviews}
                  />
                </View>
              </View>
              <TouchableOpacity
                style={styles.filterBtn}
                onPress={fetchReviews}
                disabled={reviewsLoading}
              >
                <Text style={{ color: "#fff" }}>Search</Text>
              </TouchableOpacity>
            </>
          }
          data={reviews}
          keyExtractor={(item) => item.id}
          renderItem={({ item }) => (
            <View style={styles.userRow}>
              <View style={{ flex: 1 }}>
                <Text style={{ fontWeight: "bold" }}>
                  {item.reviewer?.name || "Unknown"} - {item.rating}⭐
                </Text>
                <Text>{item.review?.substring(0, 60)}...</Text>
                <Text style={{ fontSize: 12, color: "#64748b" }}>
                  Reviewed: {item.reviewee?.name || "Unknown"}
                </Text>
              </View>
            </View>
          )}
          ListEmptyComponent={
            reviewsLoading ? (
              <Text style={{ padding: 20, textAlign: "center" }}>Loading...</Text>
            ) : (
              <Text style={{ padding: 20, textAlign: "center" }}>No reviews found</Text>
            )
          }
        />
      ) : activeSection === "reports" ? (
        <FlatList
          ListHeaderComponent={
            <>
              <Text style={styles.sectionTitle}>Reports</Text>
              <View style={{ marginBottom: 8 }}>
                <Text style={styles.filterLabel}>Search</Text>
                <View style={styles.inputBox}>
                  <TextInput
                    placeholder="Search reports..."
                    onChangeText={setSearch}
                    onSubmitEditing={fetchReports}
                  />
                </View>
              </View>
              <View style={{ marginBottom: 8 }}>
                <Text style={styles.filterLabel}>Status</Text>
                <Picker
                  selectedValue={reportStatusFilter}
                  onValueChange={setReportStatusFilter}
                >
                  <Picker.Item label="All" value="" />
                  <Picker.Item label="Open" value="open" />
                  <Picker.Item label="In Progress" value="in_progress" />
                  <Picker.Item label="Resolved" value="resolved" />
                </Picker>
              </View>
              <TouchableOpacity
                style={styles.filterBtn}
                onPress={fetchReports}
                disabled={reportsLoading}
              >
                <Text style={{ color: "#fff" }}>Search</Text>
              </TouchableOpacity>
            </>
          }
          data={reports}
          keyExtractor={(item) => item.id}
          renderItem={({ item }) => (
            <View style={styles.userRow}>
              <View style={{ flex: 1 }}>
                <Text style={{ fontWeight: "bold" }}>{item.reason}</Text>
                <Text>Reporter: {item.reporter?.name || "Unknown"}</Text>
                <Text style={{ fontSize: 12, color: "#64748b" }}>
                  Status: {item.status}
                </Text>
              </View>
            </View>
          )}
          ListEmptyComponent={
            reportsLoading ? (
              <Text style={{ padding: 20, textAlign: "center" }}>Loading...</Text>
          (
        <View style={styles.centered}>
          <Text style={styles.sectionTitle}>
            {SECTIONS.find((s) => s.key === activeSection)?.label}
          </Text>
          <Text>Section coming soon...</Text>
        </
        />      {SECTIONS.find((s) => s.key === activeSection)?.label}
            </Text>
            <Text>Section coming soon...</Text>
          </View>
        </ScrollView>
      )}
    </View>
  );
};

const { width } = Dimensions.get("window");
const styles = StyleSheet.create({
  scrollContainer: { flex: 1, backgroundColor: "#fff" },
  container: {
    flex: 1,
    padding: 16,
    backgroundColor: "#fff",
  },
  header: { fontSize: 22, fontWeight: "bold", marginBottom: 16 },

  statsRow: {
    flexDirection: "row",
    flexWrap: "wrap",
    justifyContent: "space-between",
    marginBottom: 12,
    gap: 8,
  },
  statCard: {
    flexBasis: width > 500 ? "18%" : "48%",
    minWidth: 120,
    marginHorizontal: 2,
    marginBottom: 8,
    borderRadius: 16,
    padding: 16,
    alignItems: "center",
    justifyContent: "center",
    elevation: 2,
  },
  statValue: { fontSize: 20, fontWeight: "bold" },
  statLabel: { fontSize: 12, color: "#334155" },

  tabRow: {
    flexDirection: "row",
    flexWrap: "wrap",
    marginBottom: 12,
    justifyContent: "flex-start",
    gap: 4,
  },
  tabButton: {
    flexGrow: 1,
    minWidth: 100,
    paddingVertical: 10,
    backgroundColor: "#f1f5f9",
    borderRadius: 6,
    marginHorizontal: 2,
    marginBottom: 4,
    alignItems: "center",
  },
  activeTab: { backgroundColor: "#3b82f6" },
  tabText: { fontWeight: "600" },
  activeTabText: { color: "#fff" },

  sectionContainer: { flex: 1 },
  sectionTitle: { fontSize: 18, fontWeight: "bold", marginBottom: 8 },

  filterRow: {
    flexDirection: "row",
    gap: 8,
    marginBottom: 8,
    flexWrap: "wrap",
  },
  filterLabel: { fontSize: 12 },
  inputBox: {
    borderWidth: 1,
    borderColor: "#e5e7eb",
    borderRadius: 6,
    paddingHorizontal: 8,
  },
  filterBtn: {
    backgroundColor: "#3b82f6",
    paddingHorizontal: 12,
    justifyContent: "center",
    borderRadius: 6,
    marginTop: 8,
  },

  userRow: {
    flexDirection: "row",
    padding: 12,
    borderBottomWidth: 1,
    borderColor: "#e5e7eb",
  },
  userRowSelected: { backgroundColor: "#dbeafe" },
  checkbox: {
    width: 24,
    height: 24,
    borderWidth: 1,
    marginRight: 12,
    alignItems: "center",
    justifyContent: "center",
  },

  bulkRow: { flexDirection: "row", marginTop: 8 },
  actionBtn: {
    flex: 1,
    padding: 12,
    borderRadius: 8,
    alignItems: "center",
    marginHorizontal: 4,
    marginBottom: 4,
  },
  actionText: { color: "#fff", fontWeight: "bold" },

  centered: { flex: 1, alignItems: "center", justifyContent: "center" },
  error: { color: "#dc2626", fontWeight: "bold" },
});

export default AdminDashboardScreen;
